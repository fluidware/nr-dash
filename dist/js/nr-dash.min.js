/*! nr-dash - 1.1.0 */!function(a,b,c,d,e){"use strict";function f(a,b,c){c=c||{};var d=v.defer(),f=c.width||500,g=c.height||420;return N(function(){var h,i,j,k,l,m;try{h=y.create("div",{"class":"chart"},a),i=e.newSvg("#"+h.id,f,g),j=new e.chart(i,b||[]),L.colors&&L.colors.length>0&&(j.defaultColors=L.colors.map(function(a){return new e.color(a)})),j.setBounds(60,75,f-95,275),k=j.addCategoryAxis("x","time"),k.addOrderRule("time"),k.title=null,l=j.addMeasureAxis("y","value"),c.title&&(l.title=c.title),c.tickFormat&&(l.tickFormat=c.tickFormat),m=j.addSeries("name",e.plot.line),m.interpolation="cardinal",c.id&&(j.id=c.id),j.addLegend(10,10,f-10,60,"left"),j.draw(),j.element=h,d.resolve(j)}catch(n){d.reject(n)}}),d}function g(a,b,c,d){var e,g,i,j,k={},l=[],m=[],n=0,o=0,p=!1;return void 0===K[a.id]&&(e=[],k={},g=/(.*\.)?/,x.each(a.fields,function(a){var b=B.capitalize(B.unCamelCase(B.unhyphenate(a.replace(g,""),!0)).replace(/_|-/g," "),!0);k[b]=a}),i=x.keys(k).filter(function(a){return"Name"!==a}).sort(x.sort),j={},x.each(i,function(a){j[a]=[]}),j=K[a.store.id]=h(i,k,j,a.store.records),x.each(i,function(a){var d={title:a,id:a};b.test(a)&&(d.tickFormat="s"),f(c,j[a],d).then(function(a){e.push(a),l=l.concat(y.find(a.element,"circle")),o=l.length})}),a.store.on("afterSync",function(){j=K[a.store.id]=h(i,k,j,a.store.records),d===I&&N(function(){p||(x.each(l,function(a,b){var c,d=a.id.replace(/_.*/,""),e={};B.isEmpty(a.ownerSVGElement.id)&&(a.ownerSVGElement.id="k"+v.uuid().replace(/-/g,"")),x.each(i,function(a){e[a]=j[a].filter(function(a){return a.name===d}).length}),x.contains(m,b)||(c=w("#"+a.ownerSVGElement.id+" .dimple-title")[0].innerHTML,e[c]>1&&(++n,m.push(b),d3.select(a).attr("opacity",0).on("mouseout",function(){d3.select(this).attr("opacity",0).style("opacity",0)})))}),x.each(m,function(a){d3.select(l[a]).attr("opacity",0).style("opacity",0)}),n===o&&(p=!0)),x.each(e,function(a){a.data=j[a.id],a.draw(1e3*L.transition)})})},"chartGrid")),K[a.id]}function h(a,b,c,e){var f={},g=d();return x.each(a,function(a){f[a]=c[a].filter(function(a){return g.diff(d.unix(a.unix),"minutes")<=30})}),x.each(e,function(c){var e=c.data;x.each(a,function(a){var c,g=G(e,b[a]),h=e.last_reported_at,i=d.utc(h).unix();null!==g&&void 0!==g&&(c=f[a].filter(function(a){return a.name===e.name&&a.unix===i}).length,0===c&&f[a].push({name:e.name,time:d.utc(h).zone(O).format(L.xformat),unix:d.utc(h).unix(),value:g}))})}),f}function i(b){var c=F(b);"LI"===c.nodeName&&(C(b),A(b),a.location.hash.replace("#","")!==c.childNodes[0].href.replace(R,"")&&(y.dispatch(c.childNodes[0],"click"),z("Dispatched click for navigation target/child")))}function j(a){D(function(){var a=w("ul.pills .active")[0],b=a.nextElementSibling||a.parentNode.childNodes[0];y.hasClass(b,"active")||y.dispatch(b.childNodes[0],"click")},1e3*a,"navCycle",!1)}function k(a){z(a.stack||a.message||a,"error")}function l(){b.addEventListener("hashchange",n,!1),w("nav")[0].addEventListener("click",i,!1),Q.addEventListener("render",q,!1),z("Set event listeners"),""!==I&&x.contains(r,I)?(z("Loading hash"),y.klass(w("#"+I)[0],"hidden",!1),y.klass(w("a[href='#"+I+"']")[0].parentNode,"active"),y.dispatch(Q,"render")):(z("Loading default"),a.location.hash=s)}function m(){var a=v.defer(),b=x.keySort(L.pills,"name asc"),c=[],d=[],e=L.expire&&!isNaN(L.expire);return x.each(b,function(a){c.push('<li><a href="#'+a.slug+'">'+a.name+"</a></li>"),d.push('<div id="'+a.slug+'" class="hidden"></div>')}),N(function(){var f=[];y.html(P,c.join("")),y.html(Q,d.join("")),z("Rendered Elements"),r=w("ul.pills li a").map(function(a){return a.href.replace(R,"")}),s=L["default"]||r[0],x.each(b,function(a){var b;a.uri&&(b=t(null,{id:a.slug,headers:J,key:"id",source:a.source}),f.push(b.setUri(a.uri)),e&&b.setExpires(1e3*L.expire),M[a.slug]=b)}),z("Created DataStores"),H(f).then(function(){z("Retrieved API data"),a.resolve(!0)},function(b){k(b),a.reject(b)})}),a}function n(b){var c=I?I:null,d=a.location.hash?a.location.hash.replace("#",""):null,e=c?w("#"+c)[0]:null,f=d?w("#"+d)[0]:null,g=c?w("a[href='#"+c+"']")[0]:null,h=d?w("a[href='#"+d+"']")[0]:null;C(b),A(b),g&&e&&(y.klass(g.parentNode,"active",!1),y.klass(e,"hidden")),h&&f?(I=d,y.klass(h.parentNode,"active"),y.klass(f,"hidden",!1)):(I=s,a.location.hash=s),y.dispatch(Q,"render")}function o(){var a=v.defer();return E("config").then(function(b){b.api?(z("Retrieved configuration"),v.merge(L,b),J["X-Api-Key"]=L.api,m().then(function(){l(),L.cycle&&!isNaN(L.pause)&&L.pause>0&&j(L.pause),a.resolve(!0)},function(b){a.reject(b)})):k(new Error("API key not found"))},function(b){a.reject(b)}),a}function p(){var a,b=I,c=v.defer(),e=[],f=/\:host/,g=L.pills.filter(function(a){return a.slug===b})[0].metrics;return void 0!==g&&(0===g.instances.length?c.resolve({}):(a=new Function("arg","return /^"+g.instances.map(function(a){return B.escape(a)}).join("|")+"$/i.test( arg );"),M[b].select({name:a}).then(function(a){x.each(a,function(a){var c=g.uri.replace(":id",a.key)+"?names[]="+g.names.join("&names[]="),d=B.singular(b)+"_hosts";f.test(c)?void 0!==a.data.links&&void 0!==a.data.links[d]&&a.data.links[d].length>0&&(c=c.replace(f,a.data.links[d][0]||0),e.push(E(c,"GET",null,null,null,J))):e.push(E(c,"GET",null,null,null,J))}),e.length>0?H(e).then(function(e){var f={};e instanceof Array||(e=[e]),b===I?(x.each(x.mingle(a,e.map(function(a){return null===a?a:a.metric_data.metrics})),function(a){x.each(a[1],function(b){var c,e=b.name.split("/");c="Function"===e[1]?e[2]:e[1],void 0===f[c]&&(f[c]=[]),x.each(b.timeslices,function(b){f[c].push({name:a[0].data.name,time:d.utc(b.from).zone(O).format(L.xformat),value:b.values.per_second||b.values.average_value||b.values.value||b.values.score})})})}),c.resolve(f)):c.reject(new Error("Hash has changed, data is stale"))},function(a){c.reject(a)}):c.resolve({})},function(a){c.reject(a)}))),c}function q(){var a,b,c=I,d=M[c],e=w("#"+c)[0],h=new RegExp(L.si),i=L.pills.filter(function(a){return a.slug===c})[0],j=i.fields,l=i.order;0===e.childNodes.length?(z("Rendering '"+c+"'"),void 0!==i.metrics?p().then(function(a){var k=[],m=x.keys(a).sort(x.sort);c==I&&(void 0===b&&(m.length>0||i.chartGrid===!0)&&(b=y.create("section",{"class":"charts"},e)),x.each(m,function(c){var d={title:c,id:c};h.test(c)&&(d.tickFormat="s"),k.push(f(b,a[c],d))}),N(function(){var a=u(e,d,j,j,{order:l,pageSize:L.pageSize},!0);void 0!==b&&y.klass(a.element,"hasCharts"),i.chartGrid===!0&&g(a,h,b,c),z("Rendered view of '"+c+"'")}),H(k).then(function(a){c==I&&(null!==a&&a.length>0&&z("Rendered charts for '"+c+"'"),null!==a&&a.length>0&&d.on("afterSync",function(){d.id===c&&p().then(function(b){x.each(a,function(a){try{a.data=b[a.id],N(function(){a.draw(1e3*L.transition)})}catch(c){}})})}),z("Bound charts and DataStore for '"+c+"'"))},function(){z("Failed to render charts for '"+c+"'")}))},function(a){k(a),N(function(){u(e,d,j,j,{order:l,pageSize:L.pageSize},!0),z("Rendered view of '"+c+"'")})}):(a=function(a){var b=y.find(a,"span."+B.singular(c)+"_name")[0],d=b?y.text(b):"";void 0!==b&&y.html(b,'<a title="'+d+'" class="tooltip">'+d+"</a>")},N(function(){var f;void 0===b&&i.chartGrid===!0&&(b=y.create("section",{"class":"charts"},e)),f=u(e,d,j,j,{callback:a,order:l,pageSize:L.pageSize},!0),void 0!==b&&(y.klass(f.element,"hasCharts"),g(f,h,b,c))}))):z("Viewing '"+c+"'")}var r,s,t=c.store,u=c.grid,v=c.util,w=v.$,x=v.array,y=v.element,z=v.log,A=v.stop,B=v.string,C=v.prevent,D=v.repeat,E=v.request,F=v.target,G=v.walk,H=v.when,I=a.location.hash.replace("#",""),J={},K={},L={},M={},N=v.render,O=(new Date).getTimezoneOffset(),P=w("ul.pills")[0],Q=w("section.copy")[0],R=/.*\#/;b.nrDash={charts:K,stores:M,version:"1.1.0"},o().then(function(){z("nr-dash is running")},function(){k("nr-dash failed to start")})}(document,window,keigai,moment,dimple);